# Define stages in order of execution
stages:
  - build
  - test
  - sonar
  - docker

# Build the application
build:
  stage: build
  script:
    - '& .\gradlew.bat clean assemble --no-daemon'
  artifacts:
    paths:
      - build/libs/*.jar

# Run tests
test:
  stage: test
  script:
    - >
      & .\gradlew.bat 
      -Dspring.profiles.active=test 
      -Dspring.datasource.url="jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;MODE=MySQL;DATABASE_TO_UPPER=false" 
      -Dspring.datasource.driver-class-name=org.h2.Driver 
      -Dspring.jpa.database-platform=org.hibernate.dialect.H2Dialect 
      -Dspring.jpa.hibernate.ddl-auto=update 
      test jacocoTestReport --no-daemon

# Run SonarQube analysis
sonar:
  stage: sonar
  variables:
    SONAR_HOST_URL: $SONAR_HOST_URL
    SONAR_TOKEN: $SONAR_TOKEN
  script:
    - >
      & .\gradlew.bat 
      -Dsonar.host.url=$env:SONAR_HOST_URL 
      -Dsonar.token=$env:SONAR_TOKEN 
      sonar --no-daemon


# Build Docker image
docker:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - |
      if [ -n "$DOCKER_USER" ] && [ -n "$DOCKER_PASS" ] && [ -n "$CI_REGISTRY" ] && [ -n "$CI_IMAGE" ]; then \
        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" "$CI_REGISTRY" --password-stdin ; \
        docker build -t "$CI_IMAGE:$CI_COMMIT_SHA" . ; \
        docker tag "$CI_IMAGE:$CI_COMMIT_SHA" "$CI_IMAGE:latest" ; \
        docker push "$CI_IMAGE:$CI_COMMIT_SHA" ; \
        docker push "$CI_IMAGE:latest" ; \
      else \
        echo "Skipping push; registry creds or image not configured." ; \
      fi
