# Define stages in order of execution
variables:
  # Ensure full clone so Sonar can compute blame/"new code" correctly
  GIT_DEPTH: "0"
stages:
  - build
  - test
  - sonar
  - docker

# Build the application
build:
  stage: build
  script:
    - '& .\gradlew.bat clean assemble --no-daemon'
  artifacts:
    paths:
      - build/libs/*.jar

# Run tests
test:
  stage: test
  script:
    - $env:SPRING_PROFILES_ACTIVE = 'test'
    - $env:SPRING_DATASOURCE_URL = 'jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;MODE=MySQL;DATABASE_TO_UPPER=false'
    - $env:SPRING_DATASOURCE_DRIVER_CLASS_NAME = 'org.h2.Driver'
    - $env:SPRING_JPA_DATABASE_PLATFORM = 'org.hibernate.dialect.H2Dialect'
    - $env:SPRING_JPA_HIBERNATE_DDL_AUTO = 'update'
    - '& .\gradlew.bat test jacocoTestReport --no-daemon'

# Run SonarQube analysis
sonar:
  stage: sonar
  variables:
    SONAR_HOST_URL: $SONAR_HOST_URL
    SONAR_TOKEN: $SONAR_TOKEN
  script:
    - 'git fetch --unshallow 2>$null; if ($LASTEXITCODE -ne 0) { git fetch --all --tags }'
    - '& .\gradlew.bat ''-Dsonar.qualitygate.wait=false'' sonar --no-daemon'


# Build Docker image
docker:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_DRIVER: overlay2
  script:
    - |
      if [ -n "$DOCKER_USER" ] && [ -n "$DOCKER_PASS" ] && [ -n "$CI_REGISTRY" ] && [ -n "$CI_IMAGE" ]; then \
        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" "$CI_REGISTRY" --password-stdin ; \
        docker build -t "$CI_IMAGE:$CI_COMMIT_SHA" . ; \
        docker tag "$CI_IMAGE:$CI_COMMIT_SHA" "$CI_IMAGE:latest" ; \
        docker push "$CI_IMAGE:$CI_COMMIT_SHA" ; \
        docker push "$CI_IMAGE:latest" ; \
      else \
        echo "Skipping push; registry creds or image not configured." ; \
      fi
